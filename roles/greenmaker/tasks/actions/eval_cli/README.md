# Action Name: eval_cli

## Description
This validation action executes one or more commands against a device and evaluates the combined output of all commands to look for the presence of a specified regular expression. If the regular expression is present, the action returns "true".  If the regular expression is not present, the action returns "false".  If parentheses/groups are used in the regular expression of the "pattern" argument, they can be used to extract data from the command output and assign that data to one or more variables.

## Action Definition

### Action Type
Validation Action

### Supported Input Arguments

| Name | Type | Description | Mandatory |
|------|------|-------------|-----------|
| commands | List of Strings | One or more CLI commands that should be executed against the target device for the purpose of evaluating their output and (optionally) extracting data from their output. These are typically "show" commands that do not affect the operation of the device. | Yes |
| pattern | String | Regular expression that will be searched for in the output of the CLI command(s). If the regex is found in the command output, the validation renders a true result, and the "on_true" actions for the step are executed. If the regex is not found, the validation renders a false result, and the "on_false" actions for the step are executed. This argument uses Python regular expression syntax. Regex search will occur across the aggregate output of all specified commands from the "commands" argument.  In other words, if the output of any specified command contains is matched by this regex, a result of "true" will be rendered.  Additionally, parentheses can be used to extract one or more variables from the data matched by the regular expression. The extracted content can be assigned to variables using the "target" output parameter.  | Yes |
| timeout | Integer | Timeout value in seconds for execution of CLI commands against the target device (default 60 seconds) | No |
| ignore_errors | Boolean | When set to true (default: false), the eval_cli action will not generate a failure condition when one or more of the specified commands fails to execute correctly due to syntax.  This can be helpful when executing eval_cli across different types of devices that may require different syntax for retrieving the same diagnostic data, allowing execution of multiple commands and running the pattern search against any commands that succeed. | No |

### Supported Output Parameters

| Name | Type | Description | Mandatory |
|------|------|-------------|-----------|
| source | String | Source data extracted from regex pattern match that we wish to assign to a variable for future use in Greenmaker.  Must use the value of `pattern_search[<index_number>]` for extracting data from the regex pattern match, where index_number is the index of the capture group from our regex that we want to use, starting with `pattern_search[0]` for the first capture group. | No |
| target | String | Name of the variable to which extracted regex content should be assigned. | No |

### Supported Test Input Parameters

| Name | Type | Description | Mandatory |
|------|------|-------------|-----------|
| cli_eval_data | String | Simulated output that would be generated by the command(s) specified in the "commands" argument. | Yes |

### Return Criteria ###

- Return true: When the regular expression specified in the "pattern" input argument matches the output of any of the executed "commands", a boolean value of "true" will be returned
- Return false: When the regular expression specified in the "pattern" input argument does not match the output of any of the executed "commands", a boolean value of "false" will be returned

### Supported ansible_network_os

- ios
- iosxr
- nxos
- eos

### Sample Usage

``` yaml

workflow:
  - step:
      metadata:
        name: "validate_lc_failure_after_reseat"
        description: |
          "Execute diagnostic commands to verify the health of the affected line card after physical reseat during manual action.  Extract serial number of failed LC and assign to variable.  If failure is still present, open suport case."
      validation:
        eval_cli:
          args:
            commands:
              - show module
            pattern: "{{ module_id | default() }}.+hw-faulty"
          simulation:
            input: validate_lc_failure_after_reseat_sim
      on_true:
        - echo: 
            args:
              message: |
                Line card failure still present after physical reseat.  Support case will be opened.
      on_false:
        - echo: 
            args:
              message: |
                Line card failure no longer present after physical reseat.  Exiting.
tests:
  - simulation:
      metadata:
        name: "failure_fixed_by_physical_reseat"
        description: |
          Test execution of workflow when no failure is present and resolved after physical reseat of LC
      input:
        triggers:
          alert_vars:
            syslog: "R0/0: iomd: PCIe access failed, HW faulty on Slot 2 Subslot 0. PCIe access failed, HW faulty, shutting down this slot."        
        validate_lc_failure_after_reseat_sim:
          cli_eval_data: "{{ show_module_no_failure | default('') }}"
          expected_result:
            return: false           
library:
  simulation_vars:
    - show_module_no_failure: |
        Chassis Type: C9407R

        Mod Ports Card Type                                   Model          Serial No.
        ---+-----+--------------------------------------+--------------+--------------
        1   48   48-Port UPOE 10/100/1000 (RJ-45)            C9400-LC-48U     JAE220208VH
        2   48   48-Port UPOE 10/100/1000 (RJ-45)            C9400-LC-48U     JAE2152054B
        3   10   Supervisor 1 XL Module                      C9400-SUP-1XL    JAE22030C4G
        4   10   Supervisor 1 XL Module                      C9400-SUP-1XL    JAD22510NDJ
        5   48   48-Port UPOE 10/100/1000 (RJ-45)            C9400-LC-48U     JAE213906J4
        6   48   48-Port UPOE 10/100/1000 (RJ-45)            C9400-LC-48U     JAE213802U6

        Mod MAC addresses                    Hw   Fw           Sw                 Status
        ---+--------------------------------+----+------------+------------------+--------
        1   00BE.7574.5780 to 00BE.7574.57AF 1.1  16.12.2r      16.12.01c          ok
        2   00BE.7574.35CC to 00BE.7574.35FB 1.1  16.12.2r      16.12.01c          ok
        3   005D.73B5.BFAC to 005D.73B5.BFB5 1.0  16.12.2r      16.12.01c          ok
        4   005D.73B5.BFB6 to 005D.73B5.BFBF 2.0  16.12.2r      16.12.01c          ok
        5   707D.B9CF.9F08 to 707D.B9CF.9F37 1.0  16.12.2r      16.12.01c          ok
        6   707D.B9CF.611C to 707D.B9CF.614B 1.0  16.12.2r      16.12.01c          ok

        Mod Redundancy Role     Operating Redundancy Mode Configured Redundancy Mode
        ---+-------------------+-------------------------+---------------------------
        3   Active              sso                       sso
        4   Standby             sso                       sso

        Chassis MAC address range: 44 addresses from 005d.73b5.bf80 to 005d.73b5.bfab

```