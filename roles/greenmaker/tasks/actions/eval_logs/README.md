# Action Name: eval_logs

## Description
This validation action retrieves the logging buffer for the target device (e.g. "show logging") and evaluates its contents to look for the presence of a specified regular expression. If the regular expression is present, the action returns "true".  If the regular expression is not present, the action returns "false".  If parentheses/groups are used in the regular expression of the "pattern" argument, they can be used to extract data from the command output and assign that data to one or more variables.  Additionally, a time range within which to search can be specified, and a filter can be added to only make available specific data from the log output.

## Action Definition

### Action Type
Validation Action

### Supported Input Arguments

| Name | Type | Description | Mandatory |
|------|------|-------------|-----------|
| pattern | String | Regular expression that will be searched for in the output of the logging buffer. If the regex is found in the command output, the validation renders a true result, and the "on_true" actions for the step are executed. If the regex is not found, the validation renders a false result, and the "on_false" actions for the step are executed. This argument uses Python regular expression syntax. Regex search will occur across the aggregate output of all specified commands from the "commands" argument.  In other words, if the output of any specified command contains is matched by this regex, a result of "true" will be rendered.  Additionally, parentheses can be used to extract one or more variables from the data matched by the regular expression. The extracted content can be assigned to variables using the "target" output parameter.  | Yes |
| start_time | String | Specifies the starting time for which log data should be evaluated (compared agaist timestamps in the log output).  Must be in the format of "YYYY-MM-DD HH:MM:SS". | Yes |
| end_time | String | Specifies the ending timestamp for which log data should be evaluated (compared agaist timestamps in the log output).  Must be in the format of "YYYY-MM-DD HH:MM:SS". | Yes |
| filter | String | Optionally applies a filter to the log output that is being evaluated (helpful for limiting the amount of data retrieved from the device).  For example, in Cisco IOS, we execute "show logging &#124; include \<filter\>". | No |
| timeout | Integer | Timeout value in seconds for execution of CLI commands against the target device (default 60 seconds) | No |

### Supported Output Parameters

| Name | Type | Description | Mandatory |
|------|------|-------------|-----------|
| source | String | Source data extracted from regex pattern match that we wish to assign to a variable for future use in Greenmaker.  Must use the value of `pattern_search[0][index_number]` for extracting data from the regex pattern match, where index_number is the index of the capture group from our regex that we want to use, starting with `pattern_search[0][0]` for the first capture group. | No |
| target | String | Name of the variable to which extracted regex content should be assigned. | No |

### Supported Test Input Parameters

| Name | Type | Description | Mandatory |
|------|------|-------------|-----------|
| eval_logs_data | String | Simulated output that would be generated by requesting the logs data from a device (e.g. "show logging &#124; include \<optional filter\>"). | Yes |

### Return Criteria ###

- Return true: When the regular expression specified in the "pattern" input argument matches the output of any of the log output, a boolean value of "true" will be returned
- Return false: When the regular expression specified in the "pattern" input argument does not match the output of any of the log output, a boolean value of "false" will be returned

### Supported ansible_network_os

- ios
- nxos

### Sample Usage

``` yaml

workflow:
  - step:
      metadata:
        name: "eval_logs_capture"
        description: |
          Executes "show logging | include TenGigabitEthernet3/0/2" (or equivalent command for specific OS) and looks for pattern regex in the output within the
          specified start_time and end_time range.  In the below example, we look for the presense of interface TenGigabitEthernet3/0/2 flapping (going down multiple times).
      validation:
        eval_logs:
          args:
            start_time: "2022-01-01 00:00:00"
            end_time: "2022-01-01 01:00:00"
            pattern: "LINK-3-UPDOWN.*TenGigabitEthernet3/0/2, changed state to down[\\s\\S]+LINK-3-UPDOWN.*TenGigabitEthernet3/0/2, changed state to down"
            filter: "TenGigabitEthernet3/0/2"
          settings:
            test:
              input: eval_logs_capture_test_input
      on_true:
        - echo: 
            args:
              message: |
                eval_logs found the desired pattern.
        - exit:
            args:
              reason: "Execution complete. eval_logs found the desired pattern."
      on_false:
        - echo:
            args:
              message: |
                eval_logs did not find the desired pattern in the log output
        - exit:
            args:
              reason: Unable to find desired pattern in the "show logging" command output.

# "tests" describes available tests that can be executed for this scenario in Test Mode and any relevant simulated data for the test  
tests: 
  validation:
    - metadata:
        name: default_test
        description: | 
          Test execution of eval_logs action. Inject eval_logs_data as simulated output for "show logging" command.
      extra_vars:
        - alert_vars: {}
      input:
        eval_cli_capture_test_input:
          eval_logs_data: |
            Jan  1 00:01:01.418: %LINK-3-UPDOWN: Interface TenGigabitEthernet3/0/2, changed state to down
            Jan  1 00:01:01.421: %LINEPROTO-5-UPDOWN: Line protocol on Interface TenGigabitEthernet3/0/2, changed state to down
            Jan  1 00:30:00.418: %LINK-3-UPDOWN: Interface TenGigabitEthernet3/0/2, changed state to up
            Jan  1 00:30:00.421: %LINEPROTO-5-UPDOWN: Line protocol on Interface TenGigabitEthernet3/0/2, changed state to up
            Jan  1 00:35:00.418: %LINK-3-UPDOWN: Interface TenGigabitEthernet3/0/2, changed state to down
            Jan  1 00:35:00.418: %LINEPROTO-5-UPDOWN: Line protocol on Interface TenGigabitEthernet3/0/2, changed state to down
            Jan  1 00:45:00.418: %LINK-3-UPDOWN: Interface TenGigabitEthernet3/0/2, changed state to up
            Jan  1 00:45:00.421: %LINEPROTO-5-UPDOWN: Line protocol on Interface TenGigabitEthernet3/0/2, changed state to up
            Jan  1 00:59:00.418: %LINK-3-UPDOWN: Interface TenGigabitEthernet3/0/2, changed state to down
            Jan  1 00:59:00.418: %LINEPROTO-5-UPDOWN: Line protocol on Interface TenGigabitEthernet3/0/2, changed state to down
          expected_result: 
            return: true
```
